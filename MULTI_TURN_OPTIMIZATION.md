# 多轮对话优化方案

## 问题描述

用户在第一轮对话查询了某个时间区间内的销量趋势，看到结果后想继续做环比和对比分析。但目前系统会将所有6步重新走一遍，体验不够流畅。

## 优化目标

1. **识别追问意图**：智能识别用户的追问（环比、对比、细分等），跳过重复的步骤
2. **快捷操作**：在UI层面提供快捷操作按钮（环比、对比、按维度拆分等）
3. **直接生成SQL**：对于追问场景，直接基于上次结果生成新SQL，跳过表选择、知识检索等步骤

## 方案设计

### 1. 前端快捷操作按钮

在助手消息的操作栏（MessageActions）旁边，添加快捷操作按钮：

- **环比分析**：基于上次查询结果，计算环比增长率
- **对比分析**：可以选择不同的时间段或维度进行对比
- **按维度拆分**：在现有结果基础上，按指定维度（如渠道、城市等）拆分
- **趋势预测**：基于现有趋势数据，进行预测

这些按钮只在：
- 有查询结果（有tableData）
- 是会话中的最后一次助手消息
- 时显示

### 2. 后端意图识别优化

#### 2.1 增强意图分类器

在 `IntentClassifier` 中添加更细粒度的追问类型识别：

```python
FOLLOWUP_TYPES = {
    "comparison": ["环比", "同比", "对比", "比较", "相比"],
    "breakdown": ["拆分", "细分", "分组", "按"],
    "prediction": ["预测", "趋势", "未来"],
    "drill_down": ["深入", "详细", "展开"],
}
```

#### 2.2 快速路径处理

对于追问类型的问题，可以跳过：
- ❌ 问题改写（直接使用上次上下文）
- ❌ 表选择（使用上次查询的表）
- ❌ 业务知识检索（如果需要新的知识才检索）
- ✅ 直接进入SQL生成（基于上次SQL修改）

### 3. 实现步骤

#### 阶段1：前端快捷操作（快速实现）

1. **创建快捷操作组件** `QuickActions.tsx`
   - 检测是否有tableData和SQL
   - 显示相关快捷操作按钮
   - 点击后发送对应的追问问题

2. **集成到MessageActions**
   - 在MessageActions组件中，条件渲染QuickActions
   - 只在符合条件的消息上显示

#### 阶段2：后端快速路径（深度优化）

1. **增强ConversationEnhancer**
   - 识别追问类型
   - 快速生成改写后的问题
   - 提供SQL修改建议

2. **优化SQL生成流程**
   - 对于环比：在SQL中添加时间窗口函数
   - 对于对比：使用UNION或JOIN合并多个查询
   - 对于拆分：添加GROUP BY子句

#### 阶段3：智能推理优化（高级）

1. **基于结果的分析**
   - 自动识别可以进行环比/对比的字段
   - 根据数据特征推荐分析维度

2. **上下文记忆增强**
   - 记住用户的查询习惯
   - 预测可能的后续问题

## 实现细节

### 快捷操作按钮设计

```typescript
interface QuickAction {
  label: string;
  icon: React.ReactNode;
  question: string; // 发送给后端的追问问题
  enabled: boolean; // 是否可用（基于数据特征）
}
```

### 后端快速路径示例

```python
# 环比分析快速路径
if intent == "comparison" and context.last_sql:
    # 直接修改SQL，添加环比计算
    modified_sql = add_comparison_calculation(
        original_sql=context.last_sql,
        comparison_type="环比",
        time_field=extract_time_field(context.last_sql),
    )
    # 跳过表选择、知识检索等步骤
    return {"sql": modified_sql, "skip_steps": ["tables", "knowledge"]}
```

## 用户体验优化

1. **视觉提示**：快捷操作按钮用不同颜色区分，提示用户可以快速操作
2. **加载状态**：快速路径使用"快速分析中..."提示，让用户知道系统正在使用优化路径
3. **结果对比**：环比/对比结果可以通过并排图表展示，直观展示差异

## 后续优化方向

1. **学习用户习惯**：记录用户常用的快捷操作，优先显示
2. **智能推荐**：基于数据特征，自动推荐适合的分析维度
3. **批量操作**：支持一次性进行多个分析操作









